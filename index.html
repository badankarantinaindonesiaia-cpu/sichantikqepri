<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#4e342e" />
  <title>Si Chantik Qepri - Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --font-sans: "Helvetica Neue", Helvetica, Arial, "Segoe UI", "Noto Sans", Roboto, "Apple Color Emoji", "Noto Color Emoji", sans-serif;
      --font-size: 15.5px; --font-size-lg: 17px; --font-size-xl: 18px; --line-height: 1.55;

      /* Palet coklat */
      --bg:#f1e5d1; --fg:#2c1f17; --muted:#7a6356;
      --header-bg:#4e342e; --header-fg:#fff;
      --brand:#8b5e34; --brand-hover:#744a27;
      --chat-bg:#f7efe6; --bot:#fffaf3; --user:#ead7c0;
      --border:#dec9b6; --shadow:0 10px 30px rgba(44,31,23,.08);
      --radius:16px;

      /* Safe area iOS */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }
    @media (min-width:640px){ :root{ --font-size:var(--font-size-lg); } }
    @media (min-width:1024px){ :root{ --font-size:var(--font-size-xl); } }

    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--font-sans); font-size:var(--font-size); line-height:var(--line-height);
      color:var(--fg); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; text-rendering:optimizeLegibility; letter-spacing:.005em;
      min-height:100dvh;
    }

    .wrap{ min-height:100dvh; display:grid; grid-template-rows:auto 1fr; }
    header{
      position:sticky; top:0; background:var(--header-bg); color:var(--header-fg);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:calc(.7rem + var(--safe-top)) max(1rem, calc(1rem + var(--safe-right))) .7rem max(1rem, calc(1rem + var(--safe-left)));
      z-index:10;
    }
    .header-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .brand{ display:flex; gap:.75rem; align-items:center; font-weight:700; color:var(--header-fg); min-width:0; }
    .brand .logo{ height:28px; width:28px; flex:0 0 28px; object-fit:contain; filter:drop-shadow(0 1px 1px rgba(0,0,0,.15)); }
    @media (min-width:640px){ .brand .logo{ height:32px; width:32px; } }
    .brand .title{ letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tools{ display:flex; gap:.5rem; align-items:center; }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;
      padding:.6rem .9rem; border-radius:12px; font:inherit; font-weight:600; cursor:pointer; touch-action:manipulation;
      transition:background-color .12s ease, transform .08s ease, border-color .12s ease;
    }
    .btn:hover{ background:rgba(255,255,255,.16); border-color:rgba(255,255,255,.35); }
    .btn:active{ transform:translateY(1px); }

    main{ max-width:900px; margin:0 auto; width:100%; padding:1rem max(.75rem, calc(.75rem + var(--safe-right))) calc(1.25rem + var(--safe-bottom)) max(.75rem, calc(.75rem + var(--safe-left))); display:grid; grid-template-rows:1fr; }

    .chat{
      background:var(--chat-bg); border:1px solid var(--border); border-radius:calc(var(--radius) + 4px); box-shadow:var(--shadow);
      display:grid; grid-template-rows:1fr auto; min-height:min(84dvh, 100%); overflow:hidden;
    }

    /* === Area percakapan === */
    #chat-body{
      position:relative; padding:16px; overflow-y:auto; -webkit-overflow-scrolling:touch;

      /* Logo Barantin: SELALU di tengah, tidak terpengaruh scroll */
      background-image:url('https://upload.wikimedia.org/wikipedia/id/5/53/Logo_Barantin.svg');
      background-repeat:no-repeat;
      background-position:center center;   /* kunci: center-center */
      background-size:clamp(240px, 38vw, 420px);
      background-attachment:scroll;        /* fixed terhadap elemen, tidak ikut konten */
    }
    /* Overlay putih supaya logo pudar (~35% terlihat) */
    #chat-body::before{ content:""; position:absolute; inset:0; background:rgba(255,255,255,.65); pointer-events:none; }

    .chat-bubble{
      position:relative; max-width:92%;
      padding:.8rem 2.6rem .95rem .95rem; border-radius:var(--radius);
      margin:.5rem 0; word-wrap:break-word; overflow-wrap:anywhere;
      border:1px solid var(--border); color:var(--fg); box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    @media (min-width:640px){ .chat-bubble{ max-width:88%; } }
    .bot-msg{ background:var(--bot); margin-right:auto; }
    .user-msg{ background:var(--user); margin-left:auto; border-color:#d9c0a7; }
    .meta{ font-size:.78rem; color:var(--muted); margin-top:.35rem; }
    .chat-bubble p{ margin:.25rem 0; }
    .chat-bubble strong{ font-weight:600; }

    /* Tombol copy: tersembunyi, muncul saat bubble aktif (hover/fokus/tap) */
    .copy-btn{
      position:absolute; top:8px; right:8px; font:inherit; font-size:.78rem; line-height:1;
      padding:.45rem .6rem; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:var(--fg); cursor:pointer; opacity:0; pointer-events:none;
      transition:background-color .12s ease, transform .08s ease, opacity .12s ease;
      touch-action:manipulation;
    }
    .copy-btn:hover{ background:#fff; }
    .copy-btn:active{ transform:translateY(1px); }
    .chat-bubble.is-copyable .copy-btn{ opacity:1; pointer-events:auto; }

    /* Bubble "sedang mengetik" */
    .typing{ display:flex; align-items:center; gap:.6rem; }
    .typing .dots{ display:inline-flex; gap:.25rem; align-items:center; justify-content:center; }
    .typing .dot{ width:8px; height:8px; border-radius:50%; background:#c7b299; animation:blink 1.2s infinite ease-in-out; }
    .typing .dot:nth-child(2){ animation-delay:.15s; } .typing .dot:nth-child(3){ animation-delay:.3s; }
    @keyframes blink{ 0%,80%,100%{ opacity:.25; transform:translateY(0);} 40%{ opacity:1; transform:translateY(-2px);} }

    .composer{
      position:sticky; bottom:0; display:grid; grid-template-columns:1fr auto; gap:.6rem;
      border-top:1px solid var(--border); padding:.75rem; background:var(--chat-bg);
      padding-bottom:max(.75rem, calc(.75rem + var(--safe-bottom)));
    }
    .input-wrap{ background:#fff; border:1px solid var(--border); border-radius:16px; display:flex; align-items:flex-end; padding:.6rem .8rem; gap:.6rem; }
    textarea{
      width:100%; max-height:40dvh; border:0; outline:0; font:inherit; line-height:1.5; resize:none; background:transparent; color:var(--fg);
    }
    .send{
      align-self:end; background:var(--brand); color:#fff; border:0; border-radius:16px; padding:.85rem 1.1rem; min-width:84px;
      font-weight:700; cursor:pointer; transition:background-color .12s ease, transform .08s ease; touch-action:manipulation;
    }
    .send:hover{ background:var(--brand-hover); } .send:active{ transform:translateY(1px); }
    .hint{ font-size:.82rem; color:var(--muted); padding:0 .25rem .6rem; }

    .toast{
      position:fixed; left:50%; bottom:calc(20px + var(--safe-bottom)); transform:translateX(-50%);
      background:rgba(78,52,46,.98); color:#fff; padding:.6rem .9rem; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.18); font-size:.9rem; z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    .toast.show{ opacity:1; }

    #chat-body::-webkit-scrollbar{ width:10px; }
    #chat-body::-webkit-scrollbar-thumb{ background:#d3b9a0; border-radius:10px; }
    #chat-body{ scrollbar-width:thin; scrollbar-color:#d3b9a0 transparent; }

    @media (prefers-reduced-motion: reduce){ *{ scroll-behavior:auto !important; transition:none !important; } }
  </style>
</head>
<body>
  <div class="wrap" id="appRoot">
    <header>
      <div class="header-row">
        <div class="brand">
          <img class="logo" src="https://upload.wikimedia.org/wikipedia/id/5/53/Logo_Barantin.svg" alt="Logo Barantin" width="32" height="32" />
          <div class="title">Si Chantik Qepri - Sistem Channel Interaktif Layanan Karantina Kepulauan Riau</div>
      </div>
    </header>

    <main>
      <section class="chat" role="region" aria-label="Area percakapan">
        <div id="chat-body" aria-live="polite" aria-relevant="additions">
          <div class="chat-bubble bot-msg" data-role="bot" data-raw="Halo! ðŸ‘‹
Saya **Si Chantik Pelayanan Karantina**, asisten digital yang siap membantu Anda dengan informasi terkait regulasi karantina hewan, ikan, dan tumbuhan.
Silakan sapa saya untuk memulai percakapan!">
            <button class="copy-btn" aria-label="Salin pesan ini">Salin</button>
            <p><strong>Halo! ðŸ‘‹</strong></p>
            <p>Saya <b>Si Chantik Pelayanan Karantina</b>, asisten digital yang siap membantu Anda dengan informasi terkait regulasi karantina hewan, ikan, dan tumbuhan.</p>
            <p><strong>Silakan sapa saya untuk memulai percakapan!</strong></p>
            <div class="meta">Si Chantik Qepri â€¢ <span class="time" data-auto-time></span></div>
          </div>
        </div>

        <div>
          <div class="composer" id="composer">
            <div class="input-wrap">
              <textarea id="chat-input" rows="1" placeholder="Ketik pesanâ€¦"></textarea>
            </div>
            <button id="send-btn" class="send" aria-label="Kirim pesan">Kirim</button>
          </div>
          <div class="hint">Klik <b>Kirim</b> untuk mengirim pesan. (Enter tidak mengirim)</div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">Tersalin</div>

  <script>
    const sessionId = "session_" + Math.random().toString(36).substring(2, 10);
    const chatId = "chat_" + Math.random().toString(36).substr(2, 9);

    window.ChatWidgetConfig = {
      webhook: {
        url: "https://n8n-dzlbphakiwsd.budi.sumopod.my.id/webhook/0cf95efc-39cf-4d06-aeb7-391c17012f02/chat",
        route: "general"
      },
      sessionId: sessionId
    };

    const chatBody = document.getElementById("chat-body");
    const textarea = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const copyAllBtn = document.getElementById("copy-all");
    const toastEl = document.getElementById("toast");
    const composer = document.getElementById("composer");

    function getTime(){ return new Date().toLocaleString("id-ID", { hour: "2-digit", minute: "2-digit" }); }
    document.querySelectorAll("[data-auto-time]").forEach(el => el.textContent = getTime());

    textarea.addEventListener("input", function(){
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, window.innerHeight * 0.4) + "px";
    });

    sendBtn.addEventListener("click", sendMessage);

    let toastTimer=null;
    function showToast(msg){
      toastEl.textContent = msg || "Tersalin";
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 1400);
    }

    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); showToast("Tersalin"); }
      catch(e){
        const ta=document.createElement("textarea");
        ta.value=text; ta.style.position="fixed"; ta.style.opacity="0";
        document.body.appendChild(ta); ta.focus(); ta.select();
        try{ document.execCommand("copy"); showToast("Tersalin"); }
        catch(err){ showToast("Gagal menyalin"); }
        finally{ document.body.removeChild(ta); }
      }
    }
    function getBubbleText(bubbleEl){
      const clone = bubbleEl.cloneNode(true);
      clone.querySelectorAll(".copy-btn,.meta").forEach(n=>n.remove());
      return clone.innerText.trim();
    }
    function attachCopyHandler(bubbleEl){
      const btn = bubbleEl.querySelector(".copy-btn");
      if(!btn) return;
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const raw = bubbleEl.getAttribute("data-raw");
        const text = raw || getBubbleText(bubbleEl);
        copyToClipboard(text);
      });
    }

    document.querySelectorAll(".chat-bubble").forEach(b=>{
      attachCopyHandler(b);
      b.addEventListener("mouseenter", ()=> setActiveCopyBubble(b));
      b.addEventListener("mouseleave", ()=> clearActiveCopyBubble());
      b.addEventListener("focusin", ()=> setActiveCopyBubble(b));
      b.addEventListener("focusout", ()=> clearActiveCopyBubble());
      b.addEventListener("click", (e)=>{
        if (e.target && e.target.classList.contains("copy-btn")) return;
        const isActive = b.classList.contains("is-copyable");
        clearActiveCopyBubble();
        if(!isActive){ b.classList.add("is-copyable"); }
      });
    });
    function setActiveCopyBubble(el){ clearActiveCopyBubble(); el.classList.add("is-copyable"); }
    function clearActiveCopyBubble(){ chatBody.querySelectorAll(".chat-bubble.is-copyable").forEach(n=> n.classList.remove("is-copyable")); }
    document.addEventListener("click", (e)=>{ if(!e.target.closest || !e.target.closest(".chat-bubble")) clearActiveCopyBubble(); });

    /* ====== Typing Indicator ====== */
    let typingEl = null;
    function showTyping(){
      if (typingEl) return;
      typingEl = document.createElement("div");
      typingEl.className = "chat-bubble bot-msg";
      typingEl.setAttribute("data-role", "bot");
      typingEl.setAttribute("aria-label", "Si Chantik Qepri sedang mengetik");
      typingEl.setAttribute("data-raw", "Si Chantik Qepri sedang mengetikâ€¦");
      typingEl.innerHTML = `
        <div class="typing">
          <strong>Si Chantik Qepri sedang mengetikâ€¦</strong>
          <span class="dots" aria-hidden="true">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </span>
        </div>
        <div class="meta">Si Chantik Qepri â€¢ ${getTime()}</div>
      `;
      chatBody.appendChild(typingEl);
      chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
    }
    function hideTyping(){
      if (typingEl && typingEl.parentNode){ typingEl.parentNode.removeChild(typingEl); }
      typingEl = null;
    }

    function appendBubble(rawText, type="bot"){
      const html = marked.parse(rawText || "");
      const wrap = document.createElement("div");
      wrap.className = `chat-bubble ${type === "user" ? "user-msg" : "bot-msg"}`;
      wrap.setAttribute("data-role", type === "user" ? "user" : "bot");
      wrap.setAttribute("data-raw", rawText || "");
      wrap.innerHTML = `
        <button class="copy-btn" aria-label="Salin pesan ini">Salin</button>
        ${html}
        <div class="meta">${type === "user" ? "Anda" : "Si Chantik Qepri"} â€¢ ${getTime()}</div>
      `;
      chatBody.appendChild(wrap);
      attachCopyHandler(wrap);
      wrap.addEventListener("mouseenter", ()=> setActiveCopyBubble(wrap));
      wrap.addEventListener("mouseleave", ()=> clearActiveCopyBubble());
      wrap.addEventListener("focusin", ()=> setActiveCopyBubble(wrap));
      wrap.addEventListener("focusout", ()=> clearActiveCopyBubble());
      wrap.addEventListener("click", (e)=>{
        if (e.target && e.target.classList.contains("copy-btn")) return;
        const isActive = wrap.classList.contains("is-copyable");
        clearActiveCopyBubble();
        if(!isActive){ wrap.classList.add("is-copyable"); }
      });
      chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
    }

    document.getElementById("copy-all").addEventListener("click", () => {
      const parts = [];
      chatBody.querySelectorAll(".chat-bubble").forEach(b=>{
        const who = b.getAttribute("data-role") === "user" ? "Anda" : "Si Chantik Qepri";
        const text = b.getAttribute("data-raw") || getBubbleText(b);
        parts.push(`${who}: ${text}`);
      });
      copyToClipboard(parts.join("\n\n"));
    });

    async function sendMessage(){
      const message = textarea.value.trim();
      if(!message) return;

      appendBubble(message, "user");
      textarea.value=""; textarea.style.height="auto";

      try{
        showTyping();
        const res = await fetch(window.ChatWidgetConfig.webhook.url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            chatId: "chat_" + Math.random().toString(36).substr(2, 9),
            sessionId: window.ChatWidgetConfig.sessionId,
            chatInput: message,
            route: window.ChatWidgetConfig.webhook.route
          })
        });
        const ok = res.ok;
        const data = await res.json().catch(()=>({}));
        hideTyping();
        if(!ok) throw new Error("Gagal mengirim ke server ("+res.status+")");

        const botReply = (data && (data.reply || data.message || data.output)) || "Terima kasih! Pesan Anda sudah diterima. âœ…";
        appendBubble(botReply, "bot");
      } catch(err){
        hideTyping();
        appendBubble("**Maaf, terjadi kendala koneksi.**\n\nSilakan coba lagi.\n\n<small>"+(err.message||"")+"</small>", "bot");
      }
    }

    /* Mobile ergonomics */
    if (window.visualViewport) {
      const onVVChange = () => {
        const vv = window.visualViewport;
        const kbOffset = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
        composer.style.marginBottom = kbOffset ? (kbOffset + 8) + "px" : "0px";
        chatBody.scrollTo({ top: chatBody.scrollHeight });
      };
      visualViewport.addEventListener('resize', onVVChange);
      visualViewport.addEventListener('scroll', onVVChange);
    }
    textarea.addEventListener('focus', () => {
      setTimeout(() => chatBody.scrollTo({ top: chatBody.scrollHeight }), 50);
    }, { passive: true });
  </script>
</body>
</html>
