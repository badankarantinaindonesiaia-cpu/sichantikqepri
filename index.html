<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Si Chantik Qepri - Chat Fullpage</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/geist-font/1.0.0/fonts-geist-sans/style.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body{font-family:'Geist Sans',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;margin:0;height:100vh;display:flex;flex-direction:column;background:#f5f5f5}
    #chat-header{background:#3B1C0A;color:#fff;padding:14px;display:flex;align-items:center}
    #chat-header img{height:32px;margin-right:8px}
    #chat-header-title{display:flex;align-items:center;font-size:16px;font-weight:700}
    #chat-body{flex:1;padding:16px;overflow-y:auto;background:#fff url("https://upload.wikimedia.org/wikipedia/id/thumb/5/53/Logo_Barantin.svg/2048px-Logo_Barantin.svg.png") no-repeat center center;background-size:contain;position:relative}
    #chat-body::before{content:"";position:absolute;inset:0;background:rgba(255,255,255,.65);pointer-events:none}

    .chat-bubble{margin-bottom:12px;padding:10px 12px;border-radius:8px;font-size:14px;max-width:75%;position:relative;z-index:1;cursor:pointer;user-select:text}
    .user-msg{background:#f1f1f1;color:#000;margin-left:auto}
    .bot-msg{background:#3B1C0A;color:#fff;margin-right:auto}
    .timestamp{display:block;font-size:11px;color:#ddd;margin-top:4px;text-align:right;user-select:none}

    .typing-indicator{display:inline-block;background:#3B1C0A;color:#fff;padding:6px 10px;border-radius:12px;font-size:12px;margin-top:10px;animation:blink 1.5s infinite;position:relative}
    @keyframes blink{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}

    /* LOGO SALIN – tersembunyi default, muncul saat copy berhasil */
    .copy-icon{
      position:absolute; 
      right:8px; top:8px;
      width:18px; height:18px;
      opacity:0; transform:scale(.9); 
      transition:opacity .18s ease, transform .18s ease;
      pointer-events:none; /* tidak menghalangi klik bubble */
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.25));
    }
    .chat-bubble.show-copy .copy-icon{
      opacity:1; transform:scale(1);
    }
    /* versi warna untuk bubble user & bot */
    .user-msg .copy-icon svg{fill:#333}
    .bot-msg .copy-icon svg{fill:#fff}
    
    #chat-footer{padding:12px;border-top:1px solid #ddd;display:flex;gap:10px;background:#fafafa}
    #chat-input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;outline:none;resize:none;min-height:40px;max-height:120px;overflow-y:auto}
    #chat-send{background:#3B1C0A;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
    #chat-send:hover{background:#000}
  </style>
</head>
<body>
  <!-- Header -->
  <div id="chat-header">
    <div id="chat-header-title">
      <img src="https://upload.wikimedia.org/wikipedia/id/thumb/5/53/Logo_Barantin.svg/2048px-Logo_Barantin.svg.png" alt="Logo Barantin">
      <span>Si Chantik Qepri - Sistem Channel Interaktif Layanan Karantina Kepulauan Riau</span>
    </div>
  </div>

  <!-- Body -->
  <div id="chat-body">
    <div class="chat-bubble bot-msg" title="Klik pesan untuk menyalin">
      <div class="bubble-content">
        <p><strong>Halo! 👋</strong><br>
        Saya <b>Si Chantik Pelayanan Karantina</b>, asisten digital untuk info regulasi karantina hewan, ikan, dan tumbuhan.</p>
        <p><strong>Sapa saya untuk mulai percakapan!</strong></p>
      </div>
      <!-- ikon clipboard (SVG inline) -->
      <span class="copy-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path d="M16 1H8a2 2 0 0 0-2 2v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7l-5-6ZM8 3h8v2H8V3Zm8 18H5V7h2v9a2 2 0 0 0 2 2h7v3Zm3-5H9V7h8v4h4v5Z"></path>
        </svg>
      </span>
      <span class="timestamp">--:--</span>
    </div>
  </div>

  <!-- Footer -->
  <div id="chat-footer">
    <textarea id="chat-input" placeholder="Tulis pesan Anda..."></textarea>
    <button id="chat-send">Kirim</button>
  </div>

  <script>
    // Session ID unik per reload
    const sessionId = "session_" + Math.random().toString(36).slice(2,10);

    window.ChatWidgetConfig = {
      webhook: {
        url: "https://n8n-dzlbphakiwsd.budi.sumopod.my.id/webhook/0cf95efc-39cf-4d06-aeb7-391c17012f02/chat",
        route: "general"
      },
      sessionId
    };

    const chatBody = document.getElementById("chat-body");
    const textarea = document.getElementById("chat-input");

    function getTime(){
      return new Date().toLocaleString("id-ID",{hour:"2-digit",minute:"2-digit"});
    }

    // auto-resize
    textarea.addEventListener("input", function(){
      this.style.height="auto";
      this.style.height=Math.min(this.scrollHeight,120)+"px";
    });

    function makeBubble(type, html){
      const el=document.createElement("div");
      el.className=`chat-bubble ${type}`;
      el.title="Klik pesan untuk menyalin";
      el.innerHTML=`
        <div class="bubble-content">${html}</div>
        <span class="copy-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path d="M16 1H8a2 2 0 0 0-2 2v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7l-5-6ZM8 3h8v2H8V3Zm8 18H5V7h2v9a2 2 0 0 0 2 2h7v3Zm3-5H9V7h8v4h4v5Z"></path>
          </svg>
        </span>
        <span class="timestamp">${getTime()}</span>
      `;
      return el;
    }

    // copy ke clipboard (HTTPS → Clipboard API; selain itu → fallback)
    async function copyPlainText(text){
      if (navigator.clipboard && window.isSecureContext) {
        try { await navigator.clipboard.writeText(text); return true; } catch {}
      }
      try {
        const ta=document.createElement("textarea");
        ta.value=text; ta.setAttribute("readonly","");
        ta.style.position="fixed"; ta.style.top="-9999px"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.select(); document.execCommand("copy");
        document.body.removeChild(ta); return true;
      } catch { return false; }
    }

    async function handleCopyVisual(bubble){
      // tampilkan ikon sementara
      bubble.classList.add("show-copy");
      setTimeout(()=>bubble.classList.remove("show-copy"), 900);
    }

    async function copyFromBubble(bubble){
      const content=bubble.querySelector(".bubble-content");
      const text=(content?content.textContent:bubble.textContent).trim();
      const ok = await copyPlainText(text);
      if (ok) {
        handleCopyVisual(bubble);
      } else {
        // fallback: pilih teks & beri info
        const range=document.createRange();
        range.selectNodeContents(content||bubble);
        const sel=window.getSelection();
        sel.removeAllRanges(); sel.addRange(range);
        alert("Salin otomatis gagal. Teks sudah dipilih—tekan Ctrl+C / Copy.");
      }
    }

    function sendMessage(){
      const message=textarea.value;
      if(!message.trim()) return;

      // tampilkan pesan user
      const userBubble=makeBubble("user-msg", message.replace(/\n/g,"<br>"));
      chatBody.appendChild(userBubble);

      // indikator mengetik
      const typing=document.createElement("div");
      typing.className="typing-indicator";
      typing.textContent="Si Chantik sedang mengetik...";
      chatBody.appendChild(typing);
      chatBody.scrollTop=chatBody.scrollHeight;

      fetch(window.ChatWidgetConfig.webhook.url,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          sessionId:window.ChatWidgetConfig.sessionId,
          chatInput:message,
          route:window.ChatWidgetConfig.webhook.route
        })
      })
      .then(async r=>{try{return await r.json()}catch{return{output:"⚠️ Respon bukan JSON valid dari server."}}})
      .then(data=>{
        chatBody.removeChild(typing);
        const botHtml = marked.parse(data.output || "Maaf, saya belum bisa menjawab itu.");
        const botBubble=makeBubble("bot-msg", botHtml);
        chatBody.appendChild(botBubble);
        chatBody.scrollTop=chatBody.scrollHeight;
      })
      .catch(err=>{
        chatBody.removeChild(typing);
        console.error(err);
      });

      textarea.value="";
      textarea.style.height="40px";
    }

    document.getElementById("chat-send").addEventListener("click", sendMessage);

    // klik/tap bubble → salin + tampilkan ikon
    const tap = (e)=>{
      const bubble=e.target.closest(".chat-bubble");
      if(!bubble) return;
      copyFromBubble(bubble);
    };
    chatBody.addEventListener("click", tap, false);
    chatBody.addEventListener("touchend", tap, false);

    // set timestamp bubble awal
    const firstTs=document.querySelector(".chat-bubble .timestamp");
    if(firstTs) firstTs.textContent=getTime();
  </script>
</body>
</html>
